name: SIMVEX CI/CD

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 브랜치에 따라 application-dev.yml 또는 application-prod.yml 생성
      - name: Create Configuration File
        run: |
          mkdir -p ./src/main/resources
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "${{ secrets.APPLICATION_PROD_YML }}" > ./src/main/resources/application-prod.yml
          else
            echo "${{ secrets.APPLICATION_DEV_YML }}" > ./src/main/resources/application-dev.yml
          fi
          
          # OAuth2 공통 또는 환경별 설정 파일 생성
          echo "${{ secrets.APPLICATION_OAUTH_YML }}" > ./src/main/resources/application-oauth.yml

      # 빌드 (Jar 생성)
      - name: Build with Gradle
        run: ./gradlew clean bootJar

      # Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/simvex-dev:${{ github.ref_name }}

      # 개발 서버(Dev) 배포
      - name: Deploy to Dev Server
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # 배포 디렉토리 이동 및 설정 폴더 생성
            mkdir -p ~/simvex/dev/nginx/conf.d
            cd ~/simvex/dev
            
            # .env 파일 동적 생성 (Secrets의 값을 주입)
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" > .env
            echo "IMAGE_TAG=dev" >> .env
            echo "SPRING_PROFILE=dev" >> .env
            
            # DB
            echo "POSTGRES_URL=${{ secrets.POSTGRES_URL }}" >> .env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
            
            # 구글 OAuth2
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
            
            # 최신 이미지 pull 및 컨테이너 재시작
            docker compose pull
            docker compose up -d
            
      # 메인 서버(Main) 배포
      - name: Deploy to Main Server
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MAIN_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.MAIN_EC2_SSH_KEY }}
          script: |
            # 배포 디렉토리 이동 및 설정 폴더 생성
            mkdir -p ~/simvex/main/nginx/conf.d
            cd ~/simvex/main

            # .env 파일 동적 생성 (Secrets의 값을 주입)
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" > .env
            echo "IMAGE_TAG=dev" >> .env
            echo "SPRING_PROFILE=dev" >> .env

            # DB
            echo "POSTGRES_URL=${{ secrets.POSTGRES_URL }}" >> .env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env

            # 구글 OAuth2
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env

            # 최신 이미지 pull 및 컨테이너 재시작
            docker compose pull
            docker compose up -d